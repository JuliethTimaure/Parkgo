<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Arriendos - Park Go</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico"> 
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        .tabs-container { display: flex; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid #E2E8F0; }
        .tab-btn { background: none; border: none; padding: 15px 20px; font-size: 1rem; font-weight: 600; color: #64748B; cursor: pointer; position: relative; transition: all 0.3s; }
        .tab-btn.active { color: #003B73; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: #003B73; border-radius: 3px 3px 0 0; }

        .rent-card { background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 25px; margin-bottom: 20px; display: flex; gap: 20px; transition: transform 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .rent-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .profile-side { text-align: center; min-width: 130px; display:flex; flex-direction:column; align-items:center; }
        .profile-img-rent { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #003B73; margin-bottom: 10px; }
        .profile-name { font-weight: 700; color: #1E293B; font-size: 0.95rem; }
        .role-badge { font-size: 0.7rem; background: #F1F5F9; padding: 2px 8px; border-radius: 10px; margin-top: 5px; color: #64748B;}

        .rent-details { flex: 1; border-left: 1px solid #F1F5F9; padding-left: 20px; display: flex; flex-direction: column; }
        .rent-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .rent-title { color: #003B73; font-weight: 600; font-size: 1.1rem; }
        .status-badge { background: #DCFCE7; color: #166534; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .status-badge.finished { background: #E2E8F0; color: #64748B; }

        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: #F8FAFC; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .info-item span.label-head { display: block; font-size: 0.75rem; color: #64748B; text-transform: uppercase; font-weight: 600; margin-bottom: 4px; }
        .info-item p { margin: 0; color: #334155; font-weight: 500; font-size: 0.95rem; }
        
        .vehicle-plate { font-family: 'Consolas', monospace; background: white; color: black; padding: 2px 8px 10px 8px; border: 2px solid black; border-radius: 5px; font-weight: 800; position: relative; display: inline-block; line-height: 1; }
        .vehicle-plate::after { content: 'CHILE'; position: absolute; bottom: 1px; left: 0; width: 100%; text-align: center; font-size: 8px; }

        .btn-action-outline { background: white; border: 1px solid #EF4444; color: #EF4444; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
        .btn-action-outline:hover { background: #FEF2F2; }

        .btn-map-view { background: #003B73; color: white; border: none; padding: 5px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; margin-top: 5px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-map-view:hover { background: #002a52; }

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* === MODAL MAPA === */
        .map-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .map-modal-content { background: white; width: 90%; max-width: 800px; height: 500px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .map-modal-header { padding: 15px 20px; background: #003B73; color: white; display: flex; justify-content: space-between; align-items: center; }
        .map-modal-body { flex: 1; position: relative; }
        #rentalMap { width: 100%; height: 100%; }
        .btn-close-map { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        /* === ESTILOS MODAL CALIFICACIÓN (NUEVO) === */
        .rating-container { display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 20px 0; }
        .star-widget { direction: rtl; } /* Right to left para hover css */
        .star-widget input { display: none; }
        .star-widget label { font-size: 35px; color: #E2E8F0; padding: 5px; cursor: pointer; transition: all 0.2s ease; }
        .star-widget label:hover, .star-widget label:hover ~ label, .star-widget input:checked ~ label { color: #FFD700; }
        .rating-textarea { width: 100%; border: 1px solid #CBD5E1; border-radius: 8px; padding: 12px; font-family: 'Inter', sans-serif; resize: none; margin-top: 10px; }
        .rating-textarea:focus { outline: none; border-color: #003B73; }
        
        .modal-card { background: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; }
        .modal-header-v { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #F1F5F9; padding-bottom: 10px; margin-bottom: 10px; }
        .modal-header-v h3 { margin: 0; color:#003B73; font-size:1.2rem; }
        .close-modal-v { background:none; border:none; font-size:1.5rem; color:#94A3B8; cursor:pointer; }

        @media (max-width: 768px) { .rent-card { flex-direction: column; } .rent-details { border-left: none; padding-left: 0; border-top: 1px solid #F1F5F9; padding-top: 15px; } .info-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="dashboard-body">

    <button class="mobile-toggle" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo"><img src="Logo.png" alt="Park Go"></div>
        <ul class="sidebar-menu">
            <li><a href="dashboard.html" class="sidebar-item"><i class="fa-solid fa-magnifying-glass"></i> Buscar Parking</a></li>
            <li><a href="perfil.html" class="sidebar-item"><i class="fa-regular fa-user"></i> Mi Perfil</a></li>
            <li><a href="vehiculos.html" class="sidebar-item"><i class="fa-solid fa-car"></i> Mis Vehículos</a></li>
            <li><a href="mis-estacionamientos.html" class="sidebar-item"><i class="fa-solid fa-square-parking"></i> Mis Publicaciones</a></li>
            <li><a href="gestion-arriendos.html" class="sidebar-item active"><i class="fa-solid fa-file-invoice-dollar"></i> Gestión Arriendos</a></li>
        </ul>
        <div class="sidebar-footer">
            <button class="btn-logout" id="logoutBtn"><i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar Sesión</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="dashboard-header">
            <div>
                <h1>Gestión de Arriendos</h1>
                <p style="color:#64748B;">Administra tus suscripciones y espacios alquilados.</p>
            </div>
            <div class="user-badge">
                <div class="user-avatar-sm" id="headerAvatar"><span id="headerInitial">U</span><img id="headerImg" src="" style="display:none"></div>
                <span id="headerName">...</span>
            </div>
        </header>

        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab('myRentals')">Mis Arriendos (Yo Estaciono)</button>
            <button class="tab-btn" onclick="switchTab('myTenants')">Mis Inquilinos (Soy Dueño)</button>
        </div>

        <div id="tab-myRentals" class="tab-content active">
            <div id="renterListContainer">
                <p style="text-align: center; margin-top: 50px;">Cargando tus arriendos...</p>
            </div>
        </div>

        <div id="tab-myTenants" class="tab-content">
            <div id="ownerListContainer">
                <p style="text-align: center; margin-top: 50px;">Cargando tus inquilinos...</p>
            </div>
        </div>

    </main>

    <div class="map-modal-overlay" id="mapModal">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h4 style="margin:0;"><i class="fa-solid fa-location-dot"></i> Ubicación del Estacionamiento</h4>
                <button class="btn-close-map" onclick="closeMap()">&times;</button>
            </div>
            <div class="map-modal-body">
                <div id="rentalMap"></div>
            </div>
        </div>
    </div>

    <div class="map-modal-overlay" id="ratingModal" style="display: none;">
        <div class="modal-card">
            <div class="modal-header-v">
                <h3>Calificar Experiencia</h3>
                <button class="close-modal-v" onclick="closeRatingModal()">&times;</button>
            </div>
            <form id="ratingForm">
                <input type="hidden" id="ratingContractId">
                <div class="rating-container">
                    <p style="color:#64748B; font-size:0.9rem;">¿Qué tal estuvo tu experiencia?</p>
                    
                    <div class="star-widget">
                        <input type="radio" name="rate" id="rate-5" value="5"><label for="rate-5" class="fa-solid fa-star"></label>
                        <input type="radio" name="rate" id="rate-4" value="4"><label for="rate-4" class="fa-solid fa-star"></label>
                        <input type="radio" name="rate" id="rate-3" value="3"><label for="rate-3" class="fa-solid fa-star"></label>
                        <input type="radio" name="rate" id="rate-2" value="2"><label for="rate-2" class="fa-solid fa-star"></label>
                        <input type="radio" name="rate" id="rate-1" value="1"><label for="rate-1" class="fa-solid fa-star"></label>
                    </div>

                    <textarea id="ratingComment" class="rating-textarea" rows="3" placeholder="Escribe un comentario (opcional)..." required></textarea>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Enviar Calificación</button>
            </form>
        </div>
    </div>

    <script src="js/common-dashboard.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        const token = localStorage.getItem('token');
        let currentMap = null;

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            if(tabName === 'myRentals') {
                document.getElementById('tab-myRentals').classList.add('active');
                document.querySelector('button[onclick="switchTab(\'myRentals\')"]').classList.add('active');
                loadMyRentals();
            } else {
                document.getElementById('tab-myTenants').classList.add('active');
                document.querySelector('button[onclick="switchTab(\'myTenants\')"]').classList.add('active');
                loadOwnerRents();
            }
        };

        // 1. CARGAR MIS ARRIENDOS
        async function loadMyRentals() {
            const container = document.getElementById('renterListContainer');
            try {
                const res = await fetch(`${API_URL}/rent/mine`, { headers: { 'Authorization': `Bearer ${token}` } });
                const rents = await res.json();
                
                container.innerHTML = '';
                if(rents.length === 0) {
                    container.innerHTML = emptyStateHTML('No tienes arriendos activos', 'Busca un estacionamiento y suscríbete.');
                    return;
                }

                rents.forEach(r => {
                    const avatarDue = r.url_foto_perfil || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                    const fechaFin = new Date(r.fecha_termino).toLocaleDateString('es-CL');
                    const isActive = r.estado_contrato === 'ACTIVO';
                    const estadoClass = isActive ? 'status-badge' : 'status-badge finished';
                    const estadoText = isActive ? '<i class="fa-solid fa-rotate"></i> Suscripción Activa' : 'Finalizado';
                    const horario = r.es_24_horas ? '24/7 Libre' : `${r.hora_apertura.slice(0,5)} - ${r.hora_cierre.slice(0,5)}`;
                    const wsa = `https://wa.me/${r.telefono_dueno ? r.telefono_dueno.replace(/\D/g,'') : ''}`;
                    
                    const btnTerminar = isActive ? 
                        `<button class="btn-action-outline" onclick="terminarContrato(${r.id_contrato})"><i class="fa-solid fa-ban"></i> Cancelar Suscripción</button>` : 
                        `<button class="btn-primary" onclick="openRatingModal(${r.id_contrato})" style="padding: 8px 14px; font-size:0.85rem; border-radius:6px;"><i class="fa-regular fa-star"></i> Calificar</button>`;

                    const btnMapa = (r.latitud && r.longitud) ? 
                        `<button class="btn-map-view" onclick="openMap(${r.latitud}, ${r.longitud})"><i class="fa-solid fa-map"></i> Ver Ubicación Exacta</button>` :
                        `<small style="color:#64748B;">Mapa no disponible</small>`;

                    container.innerHTML += `
                    <div class="rent-card">
                        <div class="profile-side">
                            <img src="${avatarDue}" class="profile-img-rent">
                            <div class="profile-name">${r.nombre_dueno}</div>
                            <div class="role-badge">Dueño</div>
                            <a href="${wsa}" target="_blank" style="color:#25D366; margin-top:5px; font-size:1.2rem;"><i class="fa-brands fa-whatsapp"></i></a>
                        </div>
                        <div class="rent-details">
                            <div class="rent-header">
                                <div class="rent-title">${r.titulo}</div>
                                <span class="${estadoClass}">${estadoText}</span>
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="label-head">Ubicación Completa</span>
                                    <p>${r.calle} #${r.numero_calle}</p>
                                    <p style="font-size:0.85rem; color:#64748B; margin-top:3px;">${r.nombre_comuna}, ${r.nombre_region}</p>
                                    <p style="font-size:0.9rem; color:#003B73; font-weight:700; margin-top:5px;">N° Estacionamiento: ${r.n_estacionamiento || 'S/N'}</p>
                                    ${btnMapa}
                                </div>
                                <div class="info-item">
                                    <span class="label-head">Tu Vehículo Autorizado</span>
                                    <p>${r.nombre_marca} ${r.nombre_modelo}</p>
                                    <div class="vehicle-plate">${r.patente}</div>
                                </div>
                                <div class="info-item">
                                    <span class="label-head">Horario</span>
                                    <p>${horario}</p>
                                </div>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:auto;">
                                <div style="font-size:0.85rem; color:#64748B;">
                                    <i class="fa-solid fa-calendar-check"></i> Fin contrato: ${fechaFin}
                                </div>
                                ${btnTerminar}
                            </div>
                        </div>
                    </div>`;
                });
            } catch(e) { container.innerHTML = '<p>Error cargando datos.</p>'; }
        }

        // 2. CARGAR MIS INQUILINOS
        async function loadOwnerRents() {
            const container = document.getElementById('ownerListContainer');
            try {
                const res = await fetch(`${API_URL}/rent/owner`, { headers: { 'Authorization': `Bearer ${token}` } });
                const rents = await res.json();
                
                container.innerHTML = '';
                if(rents.length === 0) {
                    container.innerHTML = emptyStateHTML('Sin inquilinos', 'Tus publicaciones aparecerán aquí cuando sean arrendadas.');
                    return;
                }

                rents.forEach(r => {
                    const avatarInq = r.url_foto_perfil || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                    const fechaFin = new Date(r.fecha_termino).toLocaleDateString('es-CL');
                    const wsa = `https://wa.me/${r.telefono ? r.telefono.replace(/\D/g,'') : ''}`;

                    container.innerHTML += `
                    <div class="rent-card">
                        <div class="profile-side">
                            <img src="${avatarInq}" class="profile-img-rent">
                            <div class="profile-name">${r.nombre_arrendatario}</div>
                            <div class="role-badge">Inquilino</div>
                            <a href="${wsa}" target="_blank" style="color:#25D366; margin-top:5px; font-size:1.2rem;"><i class="fa-brands fa-whatsapp"></i></a>
                        </div>
                        <div class="rent-details">
                            <div class="rent-header">
                                <div class="rent-title">${r.titulo}</div>
                                <span class="status-badge">ACTIVO</span>
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="label-head">Vehículo</span>
                                    <p>${r.nombre_marca} ${r.nombre_modelo}</p>
                                    <div class="vehicle-plate">${r.patente}</div>
                                </div>
                                <div class="info-item">
                                    <span class="label-head">Ubicación</span>
                                    <p>${r.calle} #${r.n_estacionamiento}</p>
                                    <p style="font-size:0.85rem; color:#64748B;">${r.nombre_comuna}, ${r.nombre_region}</p>
                                </div>
                                <div class="info-item">
                                    <span class="label-head">Renueva el</span>
                                    <p>${fechaFin}</p>
                                </div>
                            </div>
                            <div style="display:flex; justify-content:flex-end;">
                                <button class="btn-action-outline" onclick="terminarContrato(${r.id_contrato})">
                                    <i class="fa-solid fa-ban"></i> Terminar Contrato
                                </button>
                            </div>
                        </div>
                    </div>`;
                });
            } catch(e) { container.innerHTML = '<p>Error cargando datos.</p>'; }
        }

        // LÓGICA DE MAPA (MODAL)
        window.openMap = (lat, lng) => {
            const modal = document.getElementById('mapModal');
            modal.style.display = 'flex';

            if (!currentMap) {
                currentMap = L.map('rentalMap').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(currentMap);
            } else {
                currentMap.setView([lat, lng], 16);
            }

            currentMap.eachLayer((layer) => { if (layer instanceof L.Marker) { currentMap.removeLayer(layer); } });
            L.marker([lat, lng]).addTo(currentMap).bindPopup("<b>¡Aquí es!</b><br>Estacionamiento reservado.").openPopup();
            setTimeout(() => { currentMap.invalidateSize(); }, 200);
        };

        window.closeMap = () => { document.getElementById('mapModal').style.display = 'none'; };

        function emptyStateHTML(title, subtitle) {
            return `
            <div style="text-align:center; padding:50px; color:#94A3B8;">
                <i class="fa-regular fa-folder-open" style="font-size:3rem; margin-bottom:15px; color:#CBD5E1;"></i>
                <h3 style="color:#64748B;">${title}</h3>
                <p>${subtitle}</p>
            </div>`;
        }

        window.terminarContrato = async (idContrato) => {
            const { value: motivo } = await Swal.fire({
                title: '¿Cancelar suscripción?',
                text: "Se liberará el estacionamiento inmediatamente.",
                icon: 'warning',
                input: 'select',
                inputOptions: { 'Fin_Uso': 'Ya no lo necesito', 'Problemas': 'Tuve problemas con el lugar', 'Otro': 'Otro motivo' },
                inputPlaceholder: 'Selecciona motivo...',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                confirmButtonText: 'Sí, cancelar ahora'
            });

            if (motivo) {
                try {
                    const res = await fetch(`${API_URL}/rent/terminate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ id_contrato: idContrato, motivo })
                    });
                    
                    const data = await res.json();
                    
                    if(res.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Suscripción Cancelada',
                            html: `El contrato ha finalizado.<br>Reembolso estimado: <b>$${data.monto_reembolso}</b>`
                        }).then(() => location.reload());
                    } else {
                        Swal.fire('Error', data.error, 'error');
                    }
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            }
        };

        // LÓGICA DE CALIFICACIÓN (NUEVA)
        window.openRatingModal = (idContrato) => {
            document.getElementById('ratingModal').style.display = 'flex';
            document.getElementById('ratingContractId').value = idContrato;
            document.getElementById('ratingForm').reset();
        };

        window.closeRatingModal = () => {
            document.getElementById('ratingModal').style.display = 'none';
        };

        document.getElementById('ratingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idContrato = document.getElementById('ratingContractId').value;
            const rating = document.querySelector('input[name="rate"]:checked');
            const comment = document.getElementById('ratingComment').value;

            if(!rating) return Swal.fire('Falta puntuación', 'Selecciona las estrellas.', 'warning');

            try {
                const res = await fetch(`${API_URL}/ratings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ id_contrato: idContrato, puntuacion: rating.value, comentario: comment })
                });

                if(res.ok) {
                    Swal.fire('¡Gracias!', 'Tu calificación ha sido guardada.', 'success');
                    closeRatingModal();
                } else {
                    const err = await res.json();
                    Swal.fire('Error', err.error, 'error');
                }
            } catch(e) { Swal.fire('Error', 'Fallo de conexión', 'error'); }
        });

        loadMyRentals();
    </script>
</body>
</html>